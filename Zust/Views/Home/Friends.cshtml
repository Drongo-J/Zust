@using Zust.Web.Helpers.ConstantHelpers
@using Microsoft.AspNetCore.Identity;
@using Zust.Entities.Models;
@{
    var userManager = Context.RequestServices.GetService<UserManager<User>>();
    var user = await userManager.GetUserAsync(Context.User);
    ViewData["Title"] = "Zust - Friends";
}

<style>
    .single-friends-card:hover .send-message-btn {
        background-color: var(--main-color) !important;
        color: var(--white-color) !important;
    }

    .single-friends-card:hover .my-icon {
        background-color: var(--main-color) !important;
        color: var(--white-color) !important;
    }

    .add-friend-btn button,
    .add-friend-btn {
        width: 100%;
    }

    .custom-spinner-color {
        color: var(--main-color);
    }

    .tab-content {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .row {
        display: flex;
        justify-content: center;
    }

    .spinner-border {
        margin-top: 20px;
    }
</style>

<div class="page-banner-box bg-4">
    <h3>Friends</h3>
</div>

<div class="friends-inner-box-style d-flex justify-content-between align-items-center margin-top-25">
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="following-tab" data-bs-toggle="tab" href="#followings" role="tab" aria-controls="followings">Following</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="followers-tab" data-bs-toggle="tab" href="#followers" role="tab" aria-controls="followers">Followers</a>
        </li>
    </ul>
</div>

<div class="tab-content" id="myTabContent">
    <div class="tab-pane fade show active" id="followings" role="tabpanel">
        <div class="row justify-content-center" id="followings-container">
        </div>

        <div class="spinner-border custom-spinner-color" role="status" id="followings-spinner">
            <span class="sr-only"></span>
        </div>
    </div>

    <div class="tab-pane fade" id="followers" role="tabpanel">
        <div class="row justify-content-center" id="followers-container">
        </div>

        <div class="spinner-border custom-spinner-color" role="status" id="followers-spinner">
            <span class="sr-only"></span>
        </div>
    </div>
</div>

<script src="~/assets/js/jquery.min.js"></script>
<link rel="stylesheet" href="~/assets//css/main.css" />
<script src="~/assets/js/functions.js"></script>
<script>
    var currentUserId = '@user.Id.ToString()';

    async function addFollowingsToView() {
        var container = document.getElementById("followings-container");
        container.innerHTML = '';
        var followings = await getAllFollowings(currentUserId);
        if (followings === null || followings.length === 0) {
            container.innerHTML = getNoResultHtml("No Users Followed", "You're not following anyone yet. Start following users to see them here.")
        }
        else {
            for (var i = 0; i < followings.length; i++) {
                var following = followings[i];
                var id = following.id;
                var postLikesCountId = id + "-post-likes-count-p1";
                var followingsCountId = id + "-following-count-p1";
                var followersCountId = id + "-followers-count-p1";
                var html = createFollowingHtml(following, postLikesCountId, followingsCountId, followersCountId);
                container.innerHTML += html;
                console.log(followersCountId);
                await setSocialCounts(followersCountId, followingsCountId, postLikesCountId, id);
            }
        }
        document.getElementById("followings-spinner").style.display = "none";
    }

    async function addFollowersToView() {
        var container = document.getElementById("followers-container");
        container.innerHTML = '';
        var followers = await getAllFollowers(currentUserId);
        if (followers === null || followers.length === 0) {
            container.innerHTML = getNoResultHtml("No Followers Yet", "You have no followers yet. Connect with others to start gaining followers.")
        }
        else {
            for (var i = 0; i < followers.length; i++) {
                var follower = followers[i];
                var id = follower.id;
                var postLikesCountId = id + "-post-likes-count-p2";
                var followingsCountId = id + "-following-count-p2";
                var followersCountId = id + "-followers-count-p2";
                var html = createFollowerHtml(follower, postLikesCountId, followingsCountId, followersCountId);
                container.innerHTML += html;
                await setSocialCounts(followersCountId, followingsCountId, postLikesCountId, id);
            }
        }
        document.getElementById("followers-spinner").style.display = "none";
    }

    function createFollowerHtml(user, postLikesCountId, followingsCountId, followersCountId) {
        var content = `
                                <div class="col-lg-3 col-sm-6">
                                    <div class="single-friends-card">
                                        <div class="friends-image">
                                            <a href="/home/users?id=${user.id}">
                                                <img src="${user.coverImage}" alt="${user.coverImage}">
                                            </a>
                                            <div class="icon">
                                                <a href="/home/users?id=${user.id}"><i class="flaticon-user my-icon"></i></a>
                                            </div>
                                        </div>
                                        <div class="friends-content">
                                            <div class="friends-info d-flex justify-content-between align-items-center">
                                                <a href="/home/users?id=${user.id}">
                                                    <img src="${user.imageUrl}" alt="image">
                                                </a>
                                                <div class="text ms-3">
                                                    <h3><a href="/home/users?id=${user.id}">${user.userName}</a></h3>
                                                    <span>${user.email}</span>
                                                </div>
                                            </div>
                                            <ul class="statistics">
                                                <li>
                                                    <a href="#">
                                                        <span class="item-number" id=${postLikesCountId}>0</span>
                                                        <span class="item-text">Likes</span>
                                                    </a>
                                                </li>
                                                <li>
                                                    <a href="#">
                                                        <span class="item-number" id="${followingsCountId}">0</span>
                                                        <span class="item-text">Following</span>
                                                    </a>
                                                </li>
                                                <li>
                                                    <a href="#">
                                                        <span class="item-number" id="${followersCountId}">0</span>
                                                        <span class="item-text">Followers</span>
                                                    </a>
                                                </li>
                                            </ul>
                                            <div class="button-group d-flex justify-content-between align-items-center">
                                                <div class="add-friend-btn">
                                                     <button type="submit" class="send-message-btn">Send Message</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>`;
        return content;
    }

    function createFollowingHtml(user, postLikesCountId, followingsCountId, followersCountId) {
        var content = `
                                <div class="col-lg-3 col-sm-6">
                                    <div class="single-friends-card">
                                        <div class="friends-image">
                                            <a href="/home/users?id=${user.id}">
                                                <img src="${user.coverImage}" alt="${user.coverImage}">
                                            </a>
                                            <div class="icon">
                                                <a href="/home/users?id=${user.id}"><i class="flaticon-user my-icon"></i></a>
                                            </div>
                                        </div>
                                        <div class="friends-content">
                                            <div class="friends-info d-flex justify-content-between align-items-center">
                                                <a href="/home/users?id=${user.id}">
                                                    <img src="${user.imageUrl}" alt="image">
                                                </a>
                                                <div class="text ms-3">
                                                    <h3><a href="/home/users?id=${user.id}">${user.userName}</a></h3>
                                                    <span>${truncateText(user.email, 15)}</span>
                                                </div>
                                            </div>
                                            <ul class="statistics">
                                                <li>
                                                    <a href="#">
                                                        <span class="item-number" id='${postLikesCountId}'>0</span>
                                                        <span class="item-text">Likes</span>
                                                    </a>
                                                </li>
                                                <li>
                                                    <a href="#">
                                                        <span class="item-number" id='${followingsCountId}'>0</span>
                                                        <span class="item-text">Following</span>
                                                    </a>
                                                </li>
                                                <li>
                                                    <a href="#">
                                                        <span class="item-number" id="${followersCountId}">0</span>
                                                        <span class="item-text">Followers</span>
                                                    </a>
                                                </li>
                                            </ul>
                                            <div class="button-group d-flex justify-content-between align-items-center">
                                                <div class="add-friend-btn">
                                                     <button type="submit" class="send-message-btn">Send Message</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>`;
        return content;
    }

    function truncateText(text, maxLength) {
        if (text.length > maxLength) {
            return text.substring(0, maxLength) + "...";
        } else {
            return text;
        }
    }

    async function ShowUsersAsync() {
        await addFollowingsToView();
        await addFollowersToView();
    }

    ShowUsersAsync();
</script>

